version = 1

[install]
# Build tools
python311.pkg-path = "python311"
git.pkg-path = "git"
curl.pkg-path = "curl"

# Runtime dependencies (for reference/development)
postgresql_16.pkg-path = "postgresql_16"
redis.pkg-path = "redis"
kubectl.pkg-path = "kubectl"
kind.pkg-path = "kind"

[hook]
on-activate = '''

echo ""
echo "üöÄ Apache Airflow Build Environment"
echo ""
echo "Supported Versions & Builds:"
echo ""
echo "Airflow 3.1.1 (Active Support) ‚≠ê"
echo "  flox build airflow-3-1-1         - Kubernetes provider"
echo "  flox build airflow-full-3-1-1    - Multiple providers"
echo "  flox build airflow-minimal-3-1-1 - Minimal (no providers)"
echo ""
echo "Airflow 2.11.0 (Limited Support, Python 3.9+)"
echo "  flox build airflow-2-11-0         - Kubernetes provider"
echo "  flox build airflow-full-2-11-0    - Multiple providers"
echo "  flox build airflow-minimal-2-11-0 - Minimal (no providers)"
echo ""
echo "Airflow 2.10.5 (Limited Support, Python 3.8+)"
echo "  flox build airflow-2-10-5         - Kubernetes provider"
echo "  flox build airflow-full-2-10-5    - Multiple providers"
echo "  flox build airflow-minimal-2-10-5 - Minimal (no providers)"
echo ""
echo "After building:"
echo "  ./result-airflow-3-1-1/bin/airflow version"
echo "  source result-airflow-3-1-1/bin/activate"
echo ""
echo "Or use helper: activate-airflow airflow-3-1-1"
echo ""
echo "üìñ See BUILDING.md for detailed build instructions"
echo ""
'''

[build]
# ============================================================================
# AIRFLOW 3.1.1 BUILDS (Active Support, Python 3.9-3.12, K8s Provider 10.8.2)
# ============================================================================

[build.airflow-3-1-1]
version = "3.1.1"
description = "Apache Airflow 3.1.1 with Kubernetes provider (Active Support, Python 3.9-3.12)"
command = '''
AIRFLOW_VERSION="3.1.1"
PYTHON_VERSION="3.11"

echo "Building Apache Airflow ${AIRFLOW_VERSION} with Kubernetes support..."

python -m venv "$out"
source "$out/bin/activate"
pip install --upgrade pip setuptools wheel

CONSTRAINT_URL="https://raw.githubusercontent.com/apache/airflow/constraints-${AIRFLOW_VERSION}/constraints-${PYTHON_VERSION}.txt"
echo "Downloading constraints from ${CONSTRAINT_URL}..."
curl -sSL "${CONSTRAINT_URL}" -o /tmp/airflow-constraints.txt

echo "Installing apache-airflow[cncf.kubernetes]==${AIRFLOW_VERSION}..."
pip install "apache-airflow[cncf.kubernetes]==${AIRFLOW_VERSION}" \
  --constraint /tmp/airflow-constraints.txt

echo ""
echo "‚úÖ Installation complete!"
airflow version
echo ""
echo "Kubernetes provider:"
python -c "from airflow.providers.cncf.kubernetes.operators.pod import KubernetesPodOperator; print('  KubernetesPodOperator: OK')"

rm -f /tmp/airflow-constraints.txt
'''

[build.airflow-full-3-1-1]
version = "3.1.1"
description = "Apache Airflow 3.1.1 with multiple providers (Active Support, Python 3.9-3.12)"
command = '''
AIRFLOW_VERSION="3.1.1"
PYTHON_VERSION="3.11"

echo "Building Apache Airflow ${AIRFLOW_VERSION} with multiple providers..."

python -m venv "$out"
source "$out/bin/activate"
pip install --upgrade pip setuptools wheel

CONSTRAINT_URL="https://raw.githubusercontent.com/apache/airflow/constraints-${AIRFLOW_VERSION}/constraints-${PYTHON_VERSION}.txt"
echo "Downloading constraints from ${CONSTRAINT_URL}..."
curl -sSL "${CONSTRAINT_URL}" -o /tmp/airflow-constraints.txt

echo "Installing apache-airflow with multiple providers..."
pip install "apache-airflow[cncf.kubernetes,postgres,redis,http,ssh]==${AIRFLOW_VERSION}" \
  --constraint /tmp/airflow-constraints.txt

echo ""
echo "‚úÖ Full installation complete!"
airflow version
echo ""
echo "Installed providers:"
airflow providers list 2>/dev/null | grep -E "apache-airflow-providers-(cncf-kubernetes|postgres|redis|http|ssh)" || echo "  (run 'airflow providers list' after activation)"

rm -f /tmp/airflow-constraints.txt
'''

[build.airflow-minimal-3-1-1]
version = "3.1.1"
description = "Minimal Apache Airflow 3.1.1 (LocalExecutor only, Active Support, Python 3.9-3.12)"
command = '''
AIRFLOW_VERSION="3.1.1"
PYTHON_VERSION="3.11"

echo "Building minimal Apache Airflow ${AIRFLOW_VERSION}..."

python -m venv "$out"
source "$out/bin/activate"
pip install --upgrade pip setuptools wheel

CONSTRAINT_URL="https://raw.githubusercontent.com/apache/airflow/constraints-${AIRFLOW_VERSION}/constraints-${PYTHON_VERSION}.txt"
echo "Downloading constraints from ${CONSTRAINT_URL}..."
curl -sSL "${CONSTRAINT_URL}" -o /tmp/airflow-constraints.txt

echo "Installing apache-airflow (no extra providers)..."
pip install "apache-airflow==${AIRFLOW_VERSION}" \
  --constraint /tmp/airflow-constraints.txt

echo ""
echo "‚úÖ Minimal installation complete!"
airflow version

rm -f /tmp/airflow-constraints.txt
'''

# ============================================================================
# AIRFLOW 2.11.0 BUILDS (Limited Support, Python 3.9-3.12, K8s Provider 10.5.0)
# ============================================================================

[build.airflow-2-11-0]
version = "2.11.0"
description = "Apache Airflow 2.11.0 with Kubernetes provider (Limited Support, Python 3.9-3.12)"
command = '''
AIRFLOW_VERSION="2.11.0"
PYTHON_VERSION="3.11"

echo "Building Apache Airflow ${AIRFLOW_VERSION} with Kubernetes support..."

python -m venv "$out"
source "$out/bin/activate"
pip install --upgrade pip setuptools wheel

CONSTRAINT_URL="https://raw.githubusercontent.com/apache/airflow/constraints-${AIRFLOW_VERSION}/constraints-${PYTHON_VERSION}.txt"
echo "Downloading constraints from ${CONSTRAINT_URL}..."
curl -sSL "${CONSTRAINT_URL}" -o /tmp/airflow-constraints.txt

echo "Installing apache-airflow[cncf.kubernetes]==${AIRFLOW_VERSION}..."
pip install "apache-airflow[cncf.kubernetes]==${AIRFLOW_VERSION}" \
  --constraint /tmp/airflow-constraints.txt

echo ""
echo "‚úÖ Installation complete!"
airflow version
echo ""
echo "Kubernetes provider:"
python -c "from airflow.providers.cncf.kubernetes.operators.pod import KubernetesPodOperator; print('  KubernetesPodOperator: OK')"

rm -f /tmp/airflow-constraints.txt
'''

[build.airflow-full-2-11-0]
version = "2.11.0"
description = "Apache Airflow 2.11.0 with multiple providers (Limited Support, Python 3.9-3.12)"
command = '''
AIRFLOW_VERSION="2.11.0"
PYTHON_VERSION="3.11"

echo "Building Apache Airflow ${AIRFLOW_VERSION} with multiple providers..."

python -m venv "$out"
source "$out/bin/activate"
pip install --upgrade pip setuptools wheel

CONSTRAINT_URL="https://raw.githubusercontent.com/apache/airflow/constraints-${AIRFLOW_VERSION}/constraints-${PYTHON_VERSION}.txt"
echo "Downloading constraints from ${CONSTRAINT_URL}..."
curl -sSL "${CONSTRAINT_URL}" -o /tmp/airflow-constraints.txt

echo "Installing apache-airflow with multiple providers..."
pip install "apache-airflow[cncf.kubernetes,postgres,redis,http,ssh]==${AIRFLOW_VERSION}" \
  --constraint /tmp/airflow-constraints.txt

echo ""
echo "‚úÖ Full installation complete!"
airflow version
echo ""
echo "Installed providers:"
airflow providers list 2>/dev/null | grep -E "apache-airflow-providers-(cncf-kubernetes|postgres|redis|http|ssh)" || echo "  (run 'airflow providers list' after activation)"

rm -f /tmp/airflow-constraints.txt
'''

[build.airflow-minimal-2-11-0]
version = "2.11.0"
description = "Minimal Apache Airflow 2.11.0 (LocalExecutor only, Limited Support, Python 3.9-3.12)"
command = '''
AIRFLOW_VERSION="2.11.0"
PYTHON_VERSION="3.11"

echo "Building minimal Apache Airflow ${AIRFLOW_VERSION}..."

python -m venv "$out"
source "$out/bin/activate"
pip install --upgrade pip setuptools wheel

CONSTRAINT_URL="https://raw.githubusercontent.com/apache/airflow/constraints-${AIRFLOW_VERSION}/constraints-${PYTHON_VERSION}.txt"
echo "Downloading constraints from ${CONSTRAINT_URL}..."
curl -sSL "${CONSTRAINT_URL}" -o /tmp/airflow-constraints.txt

echo "Installing apache-airflow (no extra providers)..."
pip install "apache-airflow==${AIRFLOW_VERSION}" \
  --constraint /tmp/airflow-constraints.txt

echo ""
echo "‚úÖ Minimal installation complete!"
airflow version

rm -f /tmp/airflow-constraints.txt
'''

# ============================================================================
# AIRFLOW 2.10.5 BUILDS (Limited Support, Python 3.8-3.12, K8s Provider 8.4.x)
# ============================================================================

[build.airflow-2-10-5]
version = "2.10.5"
description = "Apache Airflow 2.10.5 with Kubernetes provider (Limited Support, Python 3.8-3.12)"
command = '''
AIRFLOW_VERSION="2.10.5"
PYTHON_VERSION="3.11"

echo "Building Apache Airflow ${AIRFLOW_VERSION} with Kubernetes support..."

python -m venv "$out"
source "$out/bin/activate"
pip install --upgrade pip setuptools wheel

CONSTRAINT_URL="https://raw.githubusercontent.com/apache/airflow/constraints-${AIRFLOW_VERSION}/constraints-${PYTHON_VERSION}.txt"
echo "Downloading constraints from ${CONSTRAINT_URL}..."
curl -sSL "${CONSTRAINT_URL}" -o /tmp/airflow-constraints.txt

echo "Installing apache-airflow[cncf.kubernetes]==${AIRFLOW_VERSION}..."
pip install "apache-airflow[cncf.kubernetes]==${AIRFLOW_VERSION}" \
  --constraint /tmp/airflow-constraints.txt

echo ""
echo "‚úÖ Installation complete!"
airflow version
echo ""
echo "Kubernetes provider:"
python -c "from airflow.providers.cncf.kubernetes.operators.pod import KubernetesPodOperator; print('  KubernetesPodOperator: OK')"

rm -f /tmp/airflow-constraints.txt
'''

[build.airflow-full-2-10-5]
version = "2.10.5"
description = "Apache Airflow 2.10.5 with multiple providers (Limited Support, Python 3.8-3.12)"
command = '''
AIRFLOW_VERSION="2.10.5"
PYTHON_VERSION="3.11"

echo "Building Apache Airflow ${AIRFLOW_VERSION} with multiple providers..."

python -m venv "$out"
source "$out/bin/activate"
pip install --upgrade pip setuptools wheel

CONSTRAINT_URL="https://raw.githubusercontent.com/apache/airflow/constraints-${AIRFLOW_VERSION}/constraints-${PYTHON_VERSION}.txt"
echo "Downloading constraints from ${CONSTRAINT_URL}..."
curl -sSL "${CONSTRAINT_URL}" -o /tmp/airflow-constraints.txt

echo "Installing apache-airflow with multiple providers..."
pip install "apache-airflow[cncf.kubernetes,postgres,redis,http,ssh]==${AIRFLOW_VERSION}" \
  --constraint /tmp/airflow-constraints.txt

echo ""
echo "‚úÖ Full installation complete!"
airflow version
echo ""
echo "Installed providers:"
airflow providers list 2>/dev/null | grep -E "apache-airflow-providers-(cncf-kubernetes|postgres|redis|http|ssh)" || echo "  (run 'airflow providers list' after activation)"

rm -f /tmp/airflow-constraints.txt
'''

[build.airflow-minimal-2-10-5]
version = "2.10.5"
description = "Minimal Apache Airflow 2.10.5 (LocalExecutor only, Limited Support, Python 3.8-3.12)"
command = '''
AIRFLOW_VERSION="2.10.5"
PYTHON_VERSION="3.11"

echo "Building minimal Apache Airflow ${AIRFLOW_VERSION}..."

python -m venv "$out"
source "$out/bin/activate"
pip install --upgrade pip setuptools wheel

CONSTRAINT_URL="https://raw.githubusercontent.com/apache/airflow/constraints-${AIRFLOW_VERSION}/constraints-${PYTHON_VERSION}.txt"
echo "Downloading constraints from ${CONSTRAINT_URL}..."
curl -sSL "${CONSTRAINT_URL}" -o /tmp/airflow-constraints.txt

echo "Installing apache-airflow (no extra providers)..."
pip install "apache-airflow==${AIRFLOW_VERSION}" \
  --constraint /tmp/airflow-constraints.txt

echo ""
echo "‚úÖ Minimal installation complete!"
airflow version

rm -f /tmp/airflow-constraints.txt
'''

[profile]
bash = '''
# Helper function to activate built Airflow
activate-airflow() {
    local build_name="${1:-airflow-3-1-1}"
    if [ -f "result-${build_name}/bin/activate" ]; then
        echo "Activating ${build_name}..."
        source "result-${build_name}/bin/activate"
        echo "‚úÖ Airflow activated. Run 'airflow version' to verify."
    else
        echo "‚ùå Build not found. Run: flox build ${build_name}"
        echo ""
        echo "Available builds:"
        echo "  airflow-3-1-1, airflow-full-3-1-1, airflow-minimal-3-1-1"
        echo "  airflow-2-11-0, airflow-full-2-11-0, airflow-minimal-2-11-0"
        echo "  airflow-2-10-5, airflow-full-2-10-5, airflow-minimal-2-10-5"
        return 1
    fi
}
export -f activate-airflow

# Helper to build and activate in one command
build-and-activate() {
    local build_name="${1:-airflow-3-1-1}"
    echo "Building ${build_name}..."
    flox build "${build_name}" && activate-airflow "${build_name}"
}
export -f build-and-activate
'''

zsh = '''
activate-airflow() {
    local build_name="${1:-airflow-3-1-1}"
    if [ -f "result-${build_name}/bin/activate" ]; then
        echo "Activating ${build_name}..."
        source "result-${build_name}/bin/activate"
        echo "‚úÖ Airflow activated. Run 'airflow version' to verify."
    else
        echo "‚ùå Build not found. Run: flox build ${build_name}"
        echo ""
        echo "Available builds:"
        echo "  airflow-3-1-1, airflow-full-3-1-1, airflow-minimal-3-1-1"
        echo "  airflow-2-11-0, airflow-full-2-11-0, airflow-minimal-2-11-0"
        echo "  airflow-2-10-5, airflow-full-2-10-5, airflow-minimal-2-10-5"
        return 1
    fi
}

build-and-activate() {
    local build_name="${1:-airflow-3-1-1}"
    echo "Building ${build_name}..."
    flox build "${build_name}" && activate-airflow "${build_name}"
}
'''

fish = '''
function activate-airflow
    set build_name $argv[1]
    if test -z "$build_name"
        set build_name "airflow-3-1-1"
    end

    if test -f "result-$build_name/bin/activate"
        echo "Activating $build_name..."
        source "result-$build_name/bin/activate"
        echo "‚úÖ Airflow activated. Run 'airflow version' to verify."
    else
        echo "‚ùå Build not found. Run: flox build $build_name"
        echo ""
        echo "Available builds:"
        echo "  airflow-3-1-1, airflow-full-3-1-1, airflow-minimal-3-1-1"
        echo "  airflow-2-11-0, airflow-full-2-11-0, airflow-minimal-2-11-0"
        echo "  airflow-2-10-5, airflow-full-2-10-5, airflow-minimal-2-10-5"
        return 1
    end
end

function build-and-activate
    set build_name $argv[1]
    if test -z "$build_name"
        set build_name "airflow-3-1-1"
    end

    echo "Building $build_name..."
    flox build "$build_name" && activate-airflow "$build_name"
end
'''

[options]
systems = [
  "aarch64-darwin",
  "aarch64-linux",
  "x86_64-darwin",
  "x86_64-linux",
]
